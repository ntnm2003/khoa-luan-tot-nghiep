services:
  # ---------------------------------------------------------
  # NODE 1: PRIMARY
  # ---------------------------------------------------------
  mongodb-primary:
    image: mongo:6.0
    container_name: mongodb-primary
    restart: unless-stopped
    ports:
      - "27017:27017" # Exposed to host
    volumes:
      - mongodb_primary_data:/data/db
      - ./scripts/init-replica.js:/docker-entrypoint-initdb.d/init-replica.js
    command:
      - "--replSet"
      - "myreplicaset"
      - "--bind_ip_all"
    networks:
      - mongo-net
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s

  # ---------------------------------------------------------
  # NODE 2: SECONDARY
  # ---------------------------------------------------------
  mongodb-secondary-1:
    image: mongo:6.0
    container_name: mongodb-secondary-1
    restart: unless-stopped
    ports:
      - "27018:27017"
    depends_on:
      mongodb-primary:
        condition: service_healthy
    volumes:
      - mongodb_secondary1_data:/data/db
    command:
      - "--replSet"
      - "myreplicaset"
      - "--bind_ip_all"
    networks:
      - mongo-net
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s

  # ---------------------------------------------------------
  # NODE 3: SECONDARY (or Arbiter)
  # ---------------------------------------------------------
  mongodb-secondary-2:
    image: mongo:6.0
    container_name: mongodb-secondary-2
    restart: unless-stopped
    ports:
      - "27019:27017"
    depends_on:
      mongodb-primary:
        condition: service_healthy
    volumes:
      - mongodb_secondary2_data:/data/db
    command:
      - "--replSet"
      - "myreplicaset"
      - "--bind_ip_all"
    networks:
      - mongo-net
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s

volumes:
  mongodb_primary_data:
  mongodb_secondary1_data:
  mongodb_secondary2_data:

networks:
  mongo-net:
    driver: bridge